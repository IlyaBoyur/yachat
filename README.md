# yachat

Приложение для получения и обработки сообщений от клиента.

## Технологии
Python 3.11, asyncio, factory-boy, pytest

## Быстрый старт
### 1) Добавить файл переменных среды
Примеры переменных в файле [.env.example](.env.example) в корне проекта

### 2) Установить локальное окружение
```shell
$ python3 -m venv venv
$ venv/bin/activate # Windows (Git Bash): source venv/Scripts/activate
```

### 3) Установить зависимости
```shell
$ pip install -r requirements.txt
```

### 4) Запуск сервера
```shell
# в корне проекта
$ python3 server.py
```

### 5) Запуск клиента с тестовыми операциями (в другом терминале)
```shell
# в корне проекта
$ python3 client.py
```

## Реализация

### `Сервер`
Cервис, который обрабатывает поступающие запросы от клиентов.

Особенности:
1. Клиент может добавиться в «общий» чат, где находятся ранее подключенные клиенты.
2. После подключения новому клиенту доступны последние N cообщений из общего чата (20, по умолчанию).
3. Повторно подключенный клиент имеет возможность просмотреть все ранее непрочитанные сообщения до момента последнего опроса (как из общего чата, так и приватные).
4. По умолчанию сервер стартует на локальном хосте (127.0.0.1) и на 8000 порту (есть возможность задать любой).


### `Клиент`
Cервис, который умеет подключаться к серверу для обмена сообщениями с другими клиентами.

Особенности:
1. После подключения клиент может отправлять сообщения в «общий» чат.
2. Клиент может отправлять сообщения в приватном чате (1-to-1) любому участнику из общего чата.


### Дополнительно:
- Клиент может отправлять не более 20 (по умолчанию) сообщений в общий чат в течение определенного периода — 1 час (по умолчанию). В конце каждого периода лимит обнуляется.
- Возможность комментировать сообщения.
- Возможность пожаловаться на пользователя. При достижении лимита в 3 предупреждения, пользователь становится «забанен» — невозможность отправки сообщений в течение 4 часов (по умолчанию).


### Планы по расширению приложения:
- Период жизни доставленных сообщений — 1 час (по умолчанию, можно изменить).
- Возможность создавать сообщения с заранее указанным временем отправки; созданные, но не отправленные сообщения можно отменить.
- Возможность отправлять файлы различного формата (объёмом не более 5Мб, по умолчанию).
- Возможность создавать кастомные приватные чаты и приглашать в него других пользователей. Неприглашенный пользователь может «войти» в такой чат только по сгенерированной ссылке и после подтверждения владельцем чата. 
- Пользователь может подключиться с двух и более клиентов одновременно. Состояния должны синхронизироваться между клиентами.
- Реализовать кастомную реализацию для взаимодействия по протоколу `http` (можно использовать `asyncio.streams`);


## Допущения
1. Не используются фреймворки (внешние библиотеки описаны в **requirements.txt**).
2. Информация хранится в памяти.
3. Информация для клиента выводится в консоль.
4. API - эндпойнт для http-сервиса.


## Документация
### Общее
В случае ошибки клиент получит ответ:
```python
{
    "fail": string # описание ошибки
} 
```


### **POST /connect** - зарегистрироваться на сервере

Тело запроса: нет

Ответ:
```python
{
    "token": string # уникальный номер пользователя (UUID) на сервере
} 
```


### **GET /status \<body>** - получить статус сервера

Тело запроса: 
```python
{
    "user_id": string # UUID пользователя, число чатов которого будет возвращено
}
```

Ответ: 

```python
{
    "time": string,              # текущее время сервера
    "connections_db_max": int,   # максимум подключений к базе
    "connections_db_now": int,   # сейчас подключений к базе
    "chat_default": string,      # UUID общего чата
    "chats_count": int,          # общее число чатов
    "chats_with_user_count": int,# число чатов с пользователем
    "user": {
      "id": string,                 # UUID пользователя
      "banned_when": string | null, # когда забанен
      "is_banned": bool,            # забанен ли
      "reported_times": int         # сколько раз другие пожаловались
    }
}
```


### **POST /send \<body>** - отправить сообщение

Тело запроса:
```python
{
    "author_id": string,         # UUID автора
    "chat_id": string | null,    # UUID чата или null для общего чата
    "message": string,           # сообщение
    "comment_on": string | null, # UUID сообщения, если текущее сообщение - комментарий или null в противном случае
}
```
Замечание: 
* с помощью `chat_id` можно выбрать чат для отправки сообщения, 
* с помощью `comment_on` можно сделать текущее сообщение комментарием
* установлен лимит на сообщения (по умолчанию **выключен**) - не более 20 сообщений в течение часа

Ответ: 
```python
{
    "id": string # UUID нового сообщения
}
```


### **GET /chats \<body>** - получить все чаты

Тело запроса: 
```python
{
    "user_id": string # UUID пользователя, чаты с участием которого будут возвращены
}
```
Ответ:
```python
{
  "chats": [
    {
      "id": "4b0148db-7179-4c48-b1be-23c6be94a3c9", # UUID чата
      "name": "default", # название чата
      "messages": [
        {
          "id": "24bbf014-e093-43cc-b916-909751ebd558", # UUID сообщения
          "created": "2023-04-14T03:00:24.310715+03:00", # дата сообщения
          "author": "2053f062-901d-4ce2-b84d-b912c6cd9f0f" # UUID автора сообщения
          "text": "", # текст сообщения
          "is_comment_on": null # комментируемое сообщение (если есть)
        }
      ],
      "authors": [
         "b36e255d-9f1a-4985-a2cb-718633cd1434" # UUID пользователя
      ],
      "size": 1 # число пользователей
    }
  ]
}
```


### **GET /chats \<body>** - получить историю одного чата

Тело запроса: 
```python
{
    "user_id": string # UUID пользователя
    "chat_id": string # UUID чата
}
```
Ответ:
```python
{
  "history": {
    "id": "9d2a6dfd-0563-493f-8005-1b01e4c29202",
    "name": "p2p",
    "messages": [
      {
        "id": "bcb532af-2935-4021-b7b2-e707e9f136b4",
        "created": "2023-04-14T03:05:53.118786+03:00",
        "author": "5012e337-a747-4999-9e6d-8cfd53ef72de",
        "text": "test",
        "is_comment_on": null
      }
    ],
    "authors": [
      "ca2fdba6-05f2-408d-8e7c-53017b2b2b4b",
      "5012e337-a747-4999-9e6d-8cfd53ef72de"
    ],
    "size": 2
  }
}
```


### **POST /connect_p2p \<body>** - создать приватный чат
Тело запроса:
```python
{
  "user_id": string # UUID одного пользователя
  "other_user_id": string # UUID другого пользователя
}
```

Ответ:
```python
{
  "chat_id": string # UUID p2p созданного или существующего чата
}
```


### **POST /chats/exit \<body>** - выйти из чата
Тело запроса: 
```python
{
    "user_id": string # UUID пользователя
    "chat_id": string # UUID существующего чата, который нужно покинуть

}
```
Ответ: нет


### **POST /report_user \<body>** - пожаловаться на пользователя
Тело запроса: 
```python
{
    "user_id": string          # UUID пользователя
    "reported_user_id": string # UUID нарушителя
    "reason": string           # причина жалобы

}
```
Ответ:
```python
{
  "id": string # UUID заявления
}
```


## Авторы
[Илья Боюр](https://github.com/IlyaBoyur)